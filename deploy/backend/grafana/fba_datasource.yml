# ============================================================================
# Grafana 数据源 Provisioning 配置文件
# 官方文档: https://grafana.com/docs/grafana/latest/administration/provisioning/#datasources
# 用于自动配置数据源，实现基础设施即代码
# ============================================================================

# API 版本号
# 当前仅支持版本 1
apiVersion: 1

# 数据源列表
datasources:
  # ==========================================================================
  # Loki 数据源配置
  # Loki 是 Grafana 的日志聚合系统，类似于 Prometheus 但用于日志
  # 官方文档: https://grafana.com/docs/loki/latest/
  # ==========================================================================
  - name: Loki
    uid: loki
    type: loki
    url: http://fba_loki:3100
    isDefault: false
    jsonData:
      derivedFields:
        - datasourceUid: tempo
          matcherRegex: '"traceid":"([a-f0-9]{32})"'
          matcherType: regex
          name: TraceID
          url: $${__value.raw}
          urlDisplayLabel: 查看 Trace

  # ==========================================================================
  # Prometheus 数据源配置
  # Prometheus 是云原生监控系统，用于收集和存储时序指标数据
  # 官方文档: https://prometheus.io/docs/
  # ==========================================================================
  - name: Prometheus
    uid: prometheus
    type: prometheus
    url: http://fba_prometheus:9090
    isDefault: true
    jsonData:
      httpMethod: POST
      exemplarTraceIdDestinations:
        - name: TraceID
          datasourceUid: tempo

  # ==========================================================================
  # Tempo 数据源配置
  # Tempo 是 Grafana 的分布式链路追踪后端
  # 官方文档: https://grafana.com/docs/tempo/latest/
  # ==========================================================================
  - name: Tempo
    uid: tempo
    type: tempo
    url: http://fba_tempo:3200
    jsonData:
      nodeGraph:
        enabled: true
      tracesToLogsV2:
        datasourceUid: loki
        filterByTraceID: true
        spanStartTimeShift: "-1m"
        spanEndTimeShift: "1m"
        customQuery: true
        query: '{service_name="fba_server"} | json | traceid="${__span.traceId}"'
      search:
        hide: false
      serviceMap:
        datasourceUid: prometheus
      lokiSearch:
        datasourceUid: loki
